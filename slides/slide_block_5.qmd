---
title: "Block 5"
author: "Deepak Tanwar"
editor: visual
format:
  revealjs:
    controls-layout: bottom-right
    controls-tutorial: true
    footer: "Publication ready figures with `R`"
title-slide-attributes:
  data-background-size: contain
  data-background-opacity: "0.8"
editor_options:
  chunk_output_type: console
---

## Recap of Block 4

::: incremental
-   **Statistical Summaries**: We learned to add regression lines and confidence intervals using `geom_smooth()`.
-   **`ggpubr` Package**: We used `stat_cor()` to add correlation coefficients and `stat_compare_means()` to add p-values from statistical tests.
-   **Advanced Annotations**: We explored how to label specific points on plots using `ggrepel` to avoid overlapping text.
:::

## Advanced Theming

Creating a consistent and professional look for all your plots is key for publication. Instead of customizing each plot individually, you can create a reusable theme object.

```{r, echo=FALSE}
# Load data and packages
library(ggplot2)
library(gt)
library(patchwork)
data <- readRDS(gzcon(url(
  "https://raw.githubusercontent.com/urppeia/publication_figs/main/data.rds"
)))
rownames(data$counts) <- data$counts$Gene_ID
data$counts <- data$counts[, -1]
```

```{r}
#| echo: true
# Define a universal theme
theme_publication <- function() {
  theme_bw(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
      axis.title = element_text(face = "bold"),
      axis.text = element_text(color = "black"),
      panel.grid.major = element_line(color = "grey90"),
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
}
```


---

![](https://i0.wp.com/cmdlinetips.com/wp-content/uploads/2021/06/ggplot2_theme_rectangle_tips.png){width="100%" fig-align="center"}

---

![](https://i0.wp.com/cmdlinetips.com/wp-content/uploads/2021/05/ggplot2_theme_element_text_tricks.png){width="100%" fig-align="center"}

---

![](https://i0.wp.com/cmdlinetips.com/wp-content/uploads/2021/05/ggplot2_element_line_tips.png){width="100%" fig-align="center"}

---

![](https://i0.wp.com/cmdlinetips.com/wp-content/uploads/2021/06/ggplot2_theme_element_blank_tips.png){width="100%" fig-align="center"}

---

![](https://bookdown.org/alapo/learnr/images/ggplot_elements2.png){width="100%" fig-align="center"}

---

## Introduction to `gt` for Publication Tables

![](https://gt.rstudio.com/reference/figures/gt_parts_of_a_table.svg){width="100%" fig-align="center"}

## Introduction to `gt` for Publication Tables

Figures aren't just plots; they can also be tables. The `gt` package uses a "grammar of tables" philosophy to build beautiful, publication-ready tables from data frames.

-   Start with `gt()` to create a basic table.
-   Add layers of formatting and styling.
-   Functions like `tab_header()`, `fmt_number()`, and `cols_label()` give you full control.

## Example: Creating a `gt` Table

Let's create a table of the top 5 most significant genes at 24h.

::::: columns
::: {.column width="50%"}
```r
library(gt)
library(dplyr)

# Prepare data
top_genes_table <- data$diff %>%
  filter(sucrose_24h_pval < 0.05) %>%
  arrange(sucrose_24h_pval) %>%
  head(5) %>%
  select(Gene_ID, sucrose_24h_lfc, sucrose_24h_pval)

# Create and style the table
gt_table <- gt(top_genes_table) %>%
  tab_header(
    title = "Top 5 DE Genes at 24h"
  ) %>%
  cols_label(
    Gene_ID = "Gene",
    sucrose_24h_lfc = "log2FC",
    sucrose_24h_pval = "P-value"
  ) %>%
  fmt_number(
    columns = vars(sucrose_24h_lfc),
    decimals = 2
  ) %>%
  fmt_scientific(
    columns = vars(sucrose_24h_pval),
    decimals = 2
  )
```
:::
::: {.column width="50%"}
```{r, echo=FALSE, fig.align="center", fig.height=9, dpi=300}
library(dplyr)
top_genes_table <- data$diff %>%
  filter(sucrose_24h_pval < 0.05) %>%
  arrange(sucrose_24h_pval) %>%
  head(5) %>%
  select(Gene_ID, sucrose_24h_lfc, sucrose_24h_pval)

gt_table <- gt(top_genes_table) %>%
  tab_header(
    title = "Top 5 DE Genes at 24h"
  ) %>%
  cols_label(
    Gene_ID = "Gene",
    sucrose_24h_lfc = "log2FC",
    sucrose_24h_pval = "P-value"
  ) %>%
  fmt_number(
    columns = c("sucrose_24h_lfc"),
    decimals = 2
  ) %>%
  fmt_scientific(
    columns = c("sucrose_24h_pval"),
    decimals = 2
  )
gt_table
```
:::
:::::

## Composing Plots and Tables

`patchwork` is designed for `ggplot` objects, but it can compose with other elements (like `gt` tables) if they are converted to "grobs" (grid graphical objects).


## Example: `ggplot` + `gt`

Let's combine a scatter plot with our table into a single figure.

::::: columns
::: {.column width="50%"}
```r
library(patchwork)

# Create a ggplot
p_scatter <- ggplot(data$diff, aes(x = sucrose_24h_lfc, y = -log10(sucrose_24h_pval))) +
  geom_point(alpha = 0.5) +
  theme_publication() +
  labs(title = "Volcano Plot 24h")

# Combine with patchwork
p_scatter / table_grob
```
:::
::: {.column width="50%"}
```{r, echo=FALSE, fig.align="center", fig.height=9, dpi=300}
p_scatter <- ggplot(data$diff, aes(x = sucrose_24h_lfc, y = -log10(sucrose_24h_pval))) +
  geom_point(alpha = 0.5) +
  theme_publication() +
  labs(title = "Volcano Plot 24h")

p_scatter / gt_table
```
:::
:::::

## Let's Practice!

Now, let's apply these concepts in the exercise for Block 5.